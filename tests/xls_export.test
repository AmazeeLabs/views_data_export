<?php

class XLSExportViewsDataExportTests extends ViewsDataExportBaseTest {

  protected $profile = 'testing';

  public static function getInfo() {
    return array(
      'name' => 'XLS Export',
      'description' => 'Various tests for exporting to XLS.',
      'group' => 'Views Data Export',
    );
  }

  public function testNonBatchedExport() {
    $view = $this->getXLSExportView();

    $result = $view->execute_display('vde_test');
    $expected = '<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  </head>
  <body>
    <table>
    <thead><tr><th>ID</th><th>Name</th><th>Age</th></tr></thead>    <tbody> <tr class="odd"><td>1</td><td>John</td><td>25</td> </tr>
 <tr class="even"><td>2</td><td>George</td><td>27</td> </tr>
 <tr class="odd"><td>3</td><td>Ringo</td><td>28</td> </tr>
 <tr class="even"><td>4</td><td>Paul</td><td>26</td> </tr>
 <tr class="odd"><td>5</td><td>Meredith</td><td>30</td> </tr>
      </tbody>
    </table>
  </body>
</html>';

    $this->assertExportEqual($result, $expected, 'Non batched XLS export matched expected output.');
  }

  /**
   * Build and return a basic view of the views_test table.
   *
   * @return view
   */
  protected function getXLSExportView() {
    views_include('view');

    // Create the basic view.
    $view = new view();
    $view->vid = 'test_view';
    $view->base_table = 'views_test';

    // Set up the fields we need.
    $display = $view->new_display('default', 'Master', 'default');

    $display->override_option('fields', array(
      'id' => array(
        'id' => 'id',
        'table' => 'views_test',
        'field' => 'id',
        'relationship' => 'none',
      ),
      'name' => array(
        'id' => 'name',
        'table' => 'views_test',
        'field' => 'name',
        'relationship' => 'none',
      ),
      'age' => array(
        'id' => 'age',
        'table' => 'views_test',
        'field' => 'age',
        'relationship' => 'none',
      ),
    ));

    // Set up the sort order.
    $display->override_option('sorts', array(
      'id' => array(
        'order' => 'ASC',
        'id' => 'id',
        'table' => 'views_test',
        'field' => 'id',
        'relationship' => 'none',
      ),
    ));

    // Set up the pager.
    $display->override_option('pager', array(
      'type' => 'none',
      'options' => array('offset' => 0),
    ));

    $display = $view->new_display('views_data_export', 'Data export', 'vde_test');
    $display->override_option('style_plugin', 'views_data_export_xls');
    $display->override_option('path', 'vde_test');


    return $view;
  }

}